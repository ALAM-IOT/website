<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>ALAM IOT - Plant Monitor</title>
  <script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>
  <!-- Google Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">
  <style>
    :root {
      --brand:#16a34a;
      --brand-light:#22c55e;
      --bg:#f9fafb;
      --card:#ffffff;
      --text:#1f2937;
    }
    body {
      font-family:'Poppins',system-ui,Arial;
      margin:0;
      background:var(--bg);
      color:var(--text);
    }
    header {
      background:linear-gradient(90deg,var(--brand),var(--brand-light));
      color:#fff;
      padding:14px 20px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      box-shadow:0 4px 15px rgba(0,0,0,.15);
    }
    header .left {
      display:flex;
      align-items:center;
      gap:12px;
    }
    header img {
      height:40px;
      width:40px;
      border-radius:10px;
      background:#fff;
      padding:4px;
      box-shadow:0 2px 5px rgba(0,0,0,.2);
    }
    header h1,h2 {
      margin:0;
      font-size:20px;
      font-weight:700;
    }
    .wrap {max-width:1200px;margin:22px auto;padding:0 16px}
    .grid {
      display:grid;
      gap:16px;
      grid-template-columns:repeat(auto-fit,minmax(260px,1fr));
    }
    .card {
      background:var(--card);
      padding:16px;
      border-radius:16px;
      box-shadow:0 6px 18px rgba(0,0,0,.08);
      transition:transform .2s, box-shadow .2s;
      background:linear-gradient(180deg,#ffffff,#f3f4f6);
    }
    .card:hover {transform:translateY(-4px);box-shadow:0 10px 22px rgba(0,0,0,.12)}
    .label {font-size:13px;color:#666;font-weight:500}
    .value {font-size:22px;font-weight:700;color:var(--brand);margin:6px 0 12px}
    .small {font-size:13px;color:#444}
    .mono {font-family:ui-monospace,Menlo,Consolas,monospace}
    .status {display:flex;flex-wrap:wrap;gap:10px;align-items:center;margin-bottom:16px}
    .badge {
      padding:6px 12px;
      border-radius:999px;
      font-size:13px;
      font-weight:600;
    }
    .ok{background:#dcfce7;color:#166534}
    .warn{background:#fee2e2;color:#991b1b}
    .info{background:#dbeafe;color:#1e40af}
    .controls button {
      padding:10px 14px;
      border-radius:10px;
      border:0;
      font-weight:600;
      cursor:pointer;
      margin-right:8px;
      transition:all .2s;
    }
    .controls button:hover {transform:scale(1.05)}
    .on{background:#16a34a;color:#fff}
    .off{background:#ef4444;color:#fff}
    .auto{background:#2563eb;color:#fff}
    footer {
      padding:18px;
      text-align:center;
      color:#777;
      font-size:13px;
      margin-top:30px;
      border-top:1px solid #e5e7eb;
    }
  </style>
</head>
<body>
  <header>
    <div class="left">
      <img src="logo.png" alt="Logo">
      <h2> ALAM IOT </h2>
    </div>
    <!-- clientId disembunyikan -->
  </header>

  <div class="wrap">
    <div class="card status">
      <div id="connBadge" class="badge warn">MQTT: DISCONNECTED</div>
      <div id="pumpBadge" class="badge warn">POMPA: --</div>
      <div id="modeBadge" class="badge info">MODE: --</div>
    </div>

    <div class="grid" id="mainGrid">
      <div class="card">
        <div class="label">üå° Suhu Udara</div>
        <div id="airTemp" class="value">‚Äî</div>
        <div class="label">üíß Kelembapan Udara</div>
        <div id="airHum" class="value">‚Äî</div>
      </div>

      <div class="card">
        <div class="label">‚öóÔ∏è pH Tanah</div>
        <div id="ph" class="value">‚Äî</div>
        <div class="label">‚òÄÔ∏è Cahaya</div>
        <div id="lux" class="value">‚Äî</div>
        <div class="label">üå´ CO‚ÇÇ (eCO‚ÇÇ)</div>
        <div id="co2" class="value">‚Äî</div>
      </div>

      <div id="moistureCards"></div>
      <div id="soilCards"></div>

      <div class="card">
        <div class="label">üö∞ Pompa</div>
        <div id="pumpStatus" class="value">‚Äî</div>
        <div style="margin-top:12px" class="controls">
          <button class="on" onclick="controlPump('ON')">ON</button>
          <button class="off" onclick="controlPump('OFF')">OFF</button>
          <button class="auto" onclick="controlPump('AUTO')">AUTO</button>
        </div>
      </div>

      <div class="card">
        <div class="label">‚è∞ Timer Pompa</div>
        <div id="timerStatus" class="small mono">Belum ada</div>
        <div style="margin-top:12px" class="controls">
          <label class="small">Hari</label>
          <select id="timerDay">
            <option value="0">Minggu</option>
            <option value="1">Senin</option>
            <option value="2">Selasa</option>
            <option value="3">Rabu</option>
            <option value="4">Kamis</option>
            <option value="5">Jumat</option>
            <option value="6">Sabtu</option>
          </select><br>
          <label class="small">Jam</label>
          <input id="timerHour" type="number" min="0" max="23" value="7" style="width:60px">
          <label class="small">Menit</label>
          <input id="timerMinute" type="number" min="0" max="59" value="30" style="width:60px"><br>
          <button class="on" onclick="setTimer(true)">SET</button>
          <button class="off" onclick="setTimer(false)">CLEAR</button>
        </div>
      </div>
    </div>

    <div class="card" style="margin-top:16px">
      <div class="label">üì° Last message</div>
      <div id="lastMsg" class="small mono">no messages yet</div>
    </div>

    <footer>ALAM MAN 1 MEDAN ¬© 2025 </footer>
  </div>

<script>
/* ==== MQTT SCRIPT ==== */
const TOPIC_TELE="alamproject/plantmonitor/telemetry";
const TOPIC_PUMP_SET="alamproject/plantmonitor/pump/set";
const TOPIC_PUMP_STATUS="alamproject/plantmonitor/pump/status";
const TOPIC_MODE="alamproject/plantmonitor/mode";
const TOPIC_TIMER_SET="alamproject/plantmonitor/timer/set";
const TOPIC_TIMER_STATUS="alamproject/plantmonitor/timer/status";

const brokerUrl="wss://broker.hivemq.com:8884/mqtt"; 
let clientId="webclient_"+Math.random().toString(16).slice(2);

let client=mqtt.connect(brokerUrl,{clientId,clean:true,connectTimeout:5000,reconnectPeriod:3000});

client.on('connect',()=>{
  setConn(true);
  client.subscribe([TOPIC_TELE,TOPIC_PUMP_STATUS,TOPIC_MODE,TOPIC_TIMER_STATUS]);
});
client.on('reconnect',()=>setConn(false,"RECONNECTING"));
client.on('close',()=>setConn(false));
client.on('message',(topic,message)=>{
  const msg=message.toString();
  document.getElementById('lastMsg').textContent=`[${topic}] ${msg}`;
  try{
    if(topic===TOPIC_TELE)handleTelemetry(JSON.parse(msg));
    else if(topic===TOPIC_PUMP_STATUS)handlePumpStatus(JSON.parse(msg));
    else if(topic===TOPIC_MODE)handleMode(msg);
    else if(topic===TOPIC_TIMER_STATUS)handleTimerStatus(JSON.parse(msg));
  }catch(e){console.warn(e)}
});

function setConn(ok,txt){
  const el=document.getElementById('connBadge');
  if(ok){el.textContent="MQTT: CONNECTED";el.className="badge ok"}
  else {el.textContent=txt||"MQTT: DISCONNECTED";el.className="badge warn"}
}
function safe(v,p,u){if(v==null)return"‚Äî";if(typeof v==="number"){if(isNaN(v)||v==-1)return"‚Äî";return (p?v.toFixed(p):v)+(u?(" "+u):"")}return v}

function handleTelemetry(d){
  document.getElementById('airTemp').textContent=safe(d.airTemp,1,"¬∞C");
  document.getElementById('airHum').textContent=safe(d.airHum,1,"%");
  document.getElementById('ph').textContent=safe(d.ph,2);
  document.getElementById('lux').textContent=safe(d.lux,1,"lux");
  document.getElementById('co2').textContent=safe(d.co2_eCO2,0,"ppm");

  const mWrap=document.getElementById('moistureCards');
  mWrap.innerHTML="";
  if(Array.isArray(d.moisture)){
    d.moisture.forEach((v,i)=>{
      mWrap.innerHTML+=`
        <div class="card">
          <div class="label">üíß Kelembapan Tanah ${i+1}</div>
          <div class="value">${safe(v,1,"%")}</div>
        </div>`;
    });
  }

  const sWrap=document.getElementById('soilCards');
  sWrap.innerHTML="";
  if(Array.isArray(d.soilTemps)){
    d.soilTemps.forEach((v,i)=>{
      sWrap.innerHTML+=`
        <div class="card">
          <div class="label">üå° Suhu Tanah ${i+1}</div>
          <div class="value">${safe(v,1,"¬∞C")}</div>
        </div>`;
    });
  }

  document.getElementById('pumpStatus').textContent=d.pumpState?"ON":"OFF";
  document.getElementById('pumpBadge').textContent="POMPA: "+(d.pumpState?"ON":"OFF");
  document.getElementById('pumpBadge').className="badge "+(d.pumpState?"ok":"warn");
  document.getElementById('modeBadge').textContent="MODE: "+(d.mode||"--");
  document.getElementById('modeBadge').className="badge "+((d.mode&&d.mode.toUpperCase()==="AUTO")?"ok":"info");
}

function handlePumpStatus(o){
  const on=!!o.pumpState;
  document.getElementById('pumpStatus').textContent=on?"ON":"OFF";
  document.getElementById('pumpBadge').textContent="POMPA: "+(on?"ON":"OFF");
  document.getElementById('pumpBadge').className="badge "+(on?"ok":"warn");
}
function handleMode(m){
  document.getElementById('modeBadge').textContent="MODE: "+m;
  document.getElementById('modeBadge').className="badge "+((m&&m.toUpperCase()=="AUTO")?"ok":"info");
}
function handleTimerStatus(o){
  let txt = o.enabled 
    ? `ON ‚Üí Hari ${["Minggu","Senin","Selasa","Rabu","Kamis","Jumat","Sabtu"][o.day]}, ${o.hour}:${String(o.minute).padStart(2,"0")}`
    : "OFF";
  document.getElementById('timerStatus').textContent=txt;
}
function controlPump(cmd){
  if(!client||!client.connected)return alert("Belum terhubung ke MQTT broker");
  client.publish(TOPIC_PUMP_SET,cmd);
  document.getElementById('lastMsg').textContent=`> Sent control ${cmd}`;
}
function setTimer(enable){
  if(!client||!client.connected)return alert("Belum terhubung ke MQTT broker");
  const d=parseInt(document.getElementById('timerDay').value);
  const h=parseInt(document.getElementById('timerHour').value);
  const m=parseInt(document.getElementById('timerMinute').value);
  const payload=JSON.stringify({enabled:enable,day:d,hour:h,minute:m});
  client.publish(TOPIC_TIMER_SET,payload);
  document.getElementById('lastMsg').textContent=`> Sent timer ${payload}`;
}
</script>
</body>
</html>
